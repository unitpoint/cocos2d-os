
[FILE] raw://../prog-os/main.os
[1] var director = require("director")

begin function
  begin locals, total 3
    0 _E
    1 _G
    2 director
  end locals
  begin set local var
    begin call method
      get local var _E (0 0)
      begin params 2
        push const string "require"
        ,
        push const string "director"
      end params ret values 2
    end call method ret values 1
  end set local var director (2 0)


[3] print "Hello World!" // please see all printed messages here: assets-ram/output.txt

  begin call method
    get local var _E (0 0)
    begin params 2
      push const string "print"
      ,
      push const string "Hello World!"
    end params ret values 2
  end call method ret values 0


[5] MyScene = extends Scene {

  begin set env var
    begin extends
      get env var Scene
      begin object 1

[6] __construct = function(){

        begin set by name
          begin function
            begin locals, total 6
              0 _E
              1 _G
              2 bg
              3 message
              4 Monster
              5 monster
            end locals

[7] super() // call constructor of class we extend

            begin call
              super
              begin params 0
              end params ret values 0
            end call ret values 0


[9] var bg = Image("bg.jpg") 	// create background image

            begin set local var
              begin call method
                get local var _E (0 0)
                begin params 2
                  push const string "Image"
                  ,
                  push const string "bg.jpg"
                end params ret values 2
              end call method ret values 1
            end set local var bg (2 0)


[10] bg.x = this.width / 2		// locate it at center of scene

            begin set property
              begin operator /
                begin get property
                  push this
                  push const string "width"
                end get property ret values 1
                push const number 2
              end operator /
              get local var auto create bg (2 0)
              push const string "x"
            end set property ret values 0


[11] bg.y = this.height / 2

            begin set property
              begin operator /
                begin get property
                  push this
                  push const string "height"
                end get property ret values 1
                push const number 2
              end operator /
              get local var auto create bg (2 0)
              push const string "y"
            end set property ret values 0


[12] bg.scale = math.max(this.width / bg.width, this.height / bg.height)

            begin set property
              begin call method
                get env var math
                begin params 3
                  push const string "max"
                  ,
                  begin operator /
                    begin get property
                      push this
                      push const string "width"
                    end get property ret values 1
                    begin get property
                      get local var bg (2 0)
                      push const string "width"
                    end get property ret values 1
                  end operator /
                  ,
                  begin operator /
                    begin get property
                      push this
                      push const string "height"
                    end get property ret values 1
                    begin get property
                      get local var bg (2 0)
                      push const string "height"
                    end get property ret values 1
                  end operator /
                end params ret values 3
              end call method ret values 1
              get local var auto create bg (2 0)
              push const string "scale"
            end set property ret values 0


[13] this.insert(bg)				// insert the background image to the scene

            begin call method
              push this
              begin params 2
                push const string "insert"
                ,
                get local var bg (2 0)
              end params ret values 2
            end call method ret values 0


[15] var message = Text("Sprite Sheet Animation")	// create message

            begin set local var
              begin call method
                get local var _E (0 0)
                begin params 2
                  push const string "Text"
                  ,
                  push const string "Sprite Sheet Animation"
                end params ret values 2
              end call method ret values 1
            end set local var message (3 0)


[16] message.x = this.width	// locate the message at right bottom corner

            begin set property
              begin get property
                push this
                push const string "width"
              end get property ret values 1
              get local var auto create message (3 0)
              push const string "x"
            end set property ret values 0


[17] message.y = this.height

            begin set property
              begin get property
                push this
                push const string "height"
              end get property ret values 1
              get local var auto create message (3 0)
              push const string "y"
            end set property ret values 0


[18] message.anchor = {x=1.05 y=1.05}

            begin set property
              begin object 2
                begin set by name
                  push const number 1.05
                end set by name: [x]
                ,
                begin set by name
                  push const number 1.05
                end set by name: [y]
              end object
              get local var auto create message (3 0)
              push const string "anchor"
            end set property ret values 0


[19] message.shadow = true	// we want shadow enabled

            begin set property
              const true
              get local var auto create message (3 0)
              push const string "shadow"
            end set property ret values 0


[20] this.insert(message)

            begin call method
              push this
              begin params 2
                push const string "insert"
                ,
                get local var message (3 0)
              end params ret values 2
            end call method ret values 0


[22] var Monster = extends Image { // lets create Monster class so we can create a lot instances (monsters) if necessary

            begin set local var
              begin extends
                get env var Image
                begin object 6

[23] __object = { // all instances of this class will have following properies by default

                  begin set by name
                    begin object 5

[24] curAnimName = "" // playing animation name

                      begin set by name
                        push const string ""
                      end set by name: [curAnimName]
                      ,

[25] curAnim = null	// playing animation object

                      begin set by name
                        const null
                      end set by name: [curAnim]
                      ,

[26] moveTransition = null // move transition object

                      begin set by name
                        const null
                      end set by name: [moveTransition]
                      ,

[27] prevX = 0 // prev x && prev y to track monster speed

                      begin set by name
                        push const number 0
                      end set by name: [prevX]
                      ,

[28] prevY = 0

                      begin set by name
                        push const number 0
                      end set by name: [prevY]
                    end object
                  end set by name: [__object]
                  ,

[31] __construct = function(filename, animations){

                  begin set by name
                    begin function
                      begin locals, total 4
                        0 filename (param)
                        1 animations (param)
                        2 _E
                        3 _G
                      end locals

[32] super(filename) // call constructor of class we extend, so create image

                      begin call
                        super
                        begin params 1
                          get local var filename (0 0 param)
                        end params ret values 1
                      end call ret values 0


[33] this.animations = animations

                      begin set property
                        get local var animations (1 0 param)
                        push this
                        push const string "animations"
                      end set property ret values 0


[34] this.setTimeout(this.trackMove, 0.1, true) // call this.trackMove every 0.1 seconds until we clear this timeout

                      begin call method
                        push this
                        begin params 4
                          push const string "setTimeout"
                          ,
                          begin get property
                            push this
                            push const string "trackMove"
                          end get property ret values 1
                          ,
                          push const number 0.1
                          ,
                          const true
                        end params ret values 4
                      end call method ret values 0


[35] this.runAnimation("walkRight") // run "walkRight" animation by default

                      begin call method
                        push this
                        begin params 2
                          push const string "runAnimation"
                          ,
                          push const string "walkRight"
                        end params ret values 2
                      end call method ret values 0
                    end function
                  end set by name: [__construct]
                  ,

[38] trackMove = function(){ // determine the direction of moving to switch animation

                  begin set by name
                    begin function
                      begin locals, total 5
                        0 _E
                        1 _G
                        2 dx
                        3 dy
                        4 len
                      end locals

[39] var dx, dy = this.x - this.prevX, this.y - this.prevY

                      begin set local var
                        begin set local var
                          begin params 2
                            begin operator -
                              begin get property
                                push this
                                push const string "x"
                              end get property ret values 1
                              begin get property
                                push this
                                push const string "prevX"
                              end get property ret values 1
                            end operator -
                            ,
                            begin operator -
                              begin get property
                                push this
                                push const string "y"
                              end get property ret values 1
                              begin get property
                                push this
                                push const string "prevY"
                              end get property ret values 1
                            end operator -
                          end params ret values 2
                        end set local var dy (3 0)
                      end set local var dx (2 0)


[40] this.prevX, this.prevY = this.x, this.y

                      begin set property
                        begin set property
                          begin params 2
                            begin get property
                              push this
                              push const string "x"
                            end get property ret values 1
                            ,
                            begin get property
                              push this
                              push const string "y"
                            end get property ret values 1
                          end params ret values 2
                          push this
                          push const string "prevY"
                        end set property ret values 1
                        push this
                        push const string "prevX"
                      end set property ret values 0


[41] var len = (dx*dx + dy*dy)**0.5 // calculate length of the direction

                      begin set local var
                        begin operator **
                          begin operator +
                            begin binary operator by locals
                              begin operator *
                                get local var dx (2 0)
                                get local var dx (2 0)
                              end operator *
                            end binary operator by locals
                            begin binary operator by locals
                              begin operator *
                                get local var dy (3 0)
                                get local var dy (3 0)
                              end operator *
                            end binary operator by locals
                          end operator +
                          push const number 0.5
                        end operator **
                      end set local var len (4 0)


[42] if(len == 0) return;

                      begin if
                        begin bool exp
                          begin binary operator by local & number
                            begin logic ==
                              get local var len (4 0)
                              push const number 0
                            end logic ==
                          end binary operator by local & number
                        end bool exp
                        begin then
                          return
                        end then
                      end if ret values 0


[43] dx, dy = dx / len, dy / len

                      begin set local var
                        begin set local var
                          begin params 2
                            begin binary operator by locals
                              begin operator /
                                get local var dx (2 0)
                                get local var len (4 0)
                              end operator /
                            end binary operator by locals
                            ,
                            begin binary operator by locals
                              begin operator /
                                get local var dy (3 0)
                                get local var len (4 0)
                              end operator /
                            end binary operator by locals
                          end params ret values 2
                        end set local var dy (3 0)
                      end set local var dx (2 0)


[44] if(dy < -0.85){ // monster goes up

                      begin if
                        begin bool exp
                          begin logic <
                            get local var dy (3 0)
                            begin neg
                              push const number 0.85
                            end neg
                          end logic <
                        end bool exp
                        begin then

[45] this.runAnimation("walkUp")

                          begin scope
                            begin call method
                              push this
                              begin params 2
                                push const string "runAnimation"
                                ,
                                push const string "walkUp"
                              end params ret values 2
                            end call method ret values 0


[46] this.flipX = false

                            begin set property
                              const false
                              push this
                              push const string "flipX"
                            end set property ret values 0
                          end scope ret values 0
                        end then
                        begin else

[47] }else if(dy > 0.85){ // monster goes down

                          begin if
                            begin bool exp
                              begin binary operator by local & number
                                begin logic >
                                  get local var dy (3 0)
                                  push const number 0.85
                                end logic >
                              end binary operator by local & number
                            end bool exp
                            begin then

[48] this.runAnimation("walkDown")

                              begin scope
                                begin call method
                                  push this
                                  begin params 2
                                    push const string "runAnimation"
                                    ,
                                    push const string "walkDown"
                                  end params ret values 2
                                end call method ret values 0


[49] this.flipX = false

                                begin set property
                                  const false
                                  push this
                                  push const string "flipX"
                                end set property ret values 0
                              end scope ret values 0
                            end then
                            begin else

[51] this.runAnimation("walkRight");

                              begin scope
                                begin call method
                                  push this
                                  begin params 2
                                    push const string "runAnimation"
                                    ,
                                    push const string "walkRight"
                                  end params ret values 2
                                end call method ret values 0


[52] this.flipX = dx < 0

                                begin set property
                                  begin binary operator by local & number
                                    begin logic <
                                      get local var dx (2 0)
                                      push const number 0
                                    end logic <
                                  end binary operator by local & number
                                  push this
                                  push const string "flipX"
                                end set property ret values 0
                              end scope ret values 0
                            end else
                          end if ret values 0
                        end else
                      end if ret values 0
                    end function
                  end set by name: [trackMove]
                  ,

[56] runAnimation = function(name){ // start animation

                  begin set by name
                    begin function
                      begin locals, total 3
                        0 name (param)
                        1 _E
                        2 _G
                      end locals

[57] if(this.curAnimName == name) return;

                      begin if
                        begin bool exp
                          begin logic ==
                            begin get property
                              push this
                              push const string "curAnimName"
                            end get property ret values 1
                            get local var name (0 0 param)
                          end logic ==
                        end bool exp
                        begin then
                          return
                        end then
                      end if ret values 0


[58] this.curAnimName = name

                      begin set property
                        get local var name (0 0 param)
                        push this
                        push const string "curAnimName"
                      end set property ret values 0


[59] this.stopAnimation(this.curAnim)

                      begin call method
                        push this
                        begin params 2
                          push const string "stopAnimation"
                          ,
                          begin get property
                            push this
                            push const string "curAnim"
                          end get property ret values 1
                        end params ret values 2
                      end call method ret values 0


[60] this.curAnim = this.animation(this.animations[name])

                      begin set property
                        begin call method
                          push this
                          begin params 2
                            push const string "animation"
                            ,
                            begin get property
                              begin get property
                                push this
                                push const string "animations"
                              end get property ret values 1
                              get local var name (0 0 param)
                            end get property ret values 1
                          end params ret values 2
                        end call method ret values 1
                        push this
                        push const string "curAnim"
                      end set property ret values 0
                    end function
                  end set by name: [runAnimation]
                  ,

[63] move = function(x, y){ // move monster to position x,y

                  begin set by name
                    begin function
                      begin locals, total 5
                        0 x (param)
                        1 y (param)
                        2 _E
                        3 _G
                        4 len
                      end locals

[64] var len = ((this.x - x)**2 + (this.y - y)**2)**0.5

                      begin set local var
                        begin operator **
                          begin operator +
                            begin operator **
                              begin operator -
                                begin get property
                                  push this
                                  push const string "x"
                                end get property ret values 1
                                get local var x (0 0 param)
                              end operator -
                              push const number 2
                            end operator **
                            begin operator **
                              begin operator -
                                begin get property
                                  push this
                                  push const string "y"
                                end get property ret values 1
                                get local var y (1 0 param)
                              end operator -
                              push const number 2
                            end operator **
                          end operator +
                          push const number 0.5
                        end operator **
                      end set local var len (4 0)


[65] this.stopTransition(this.moveTransition)

                      begin call method
                        push this
                        begin params 2
                          push const string "stopTransition"
                          ,
                          begin get property
                            push this
                            push const string "moveTransition"
                          end get property ret values 1
                        end params ret values 2
                      end call method ret values 0


[66] this.moveTransition = this.transition { // lets use transition to move monster

                      begin set property
                        begin call method
                          push this
                          begin params 2
                            push const string "transition"
                            ,
                            begin object 3

[67] x = x, y = y

                              begin set by name
                                get local var x (0 0 param)
                              end set by name: [x]
                              ,
                              begin set by name
                                get local var y (1 0 param)
                              end set by name: [y]
                              ,

[68] duration = len * 10.0 / director.contentWidth

                              begin set by name
                                begin operator /
                                  begin binary operator by local & number
                                    begin operator *
                                      get local var len (4 0)
                                      push const number 10.0
                                    end operator *
                                  end binary operator by local & number
                                  begin get property
                                    get local var director (2 2)
                                    push const string "contentWidth"
                                  end get property ret values 1
                                end operator /
                              end set by name: [duration]
                            end object
                          end params ret values 2
                        end call method ret values 1

[66] this.moveTransition = this.transition { // lets use transition to move monster

                        push this
                        push const string "moveTransition"
                      end set property ret values 0
                    end function
                  end set by name: [move]
                  ,

[72] __set@y = function(y){ // track changing y position

                  begin set by name
                    begin function
                      begin locals, total 3
                        0 y (param)
                        1 _E
                        2 _G
                      end locals

[73] super(y) // call the same method of "super" class because we want to add behavior, not override

                      begin call
                        super
                        begin params 1
                          get local var y (0 0 param)
                        end params ret values 1
                      end call ret values 0


[74] this.zOrder = y // set zOrder, so bottom monsters will be front of top monsters

                      begin set property
                        get local var y (0 0 param)
                        push this
                        push const string "zOrder"
                      end set property ret values 0
                    end function
                  end set by name: [__set@y]
                end object
              end extends ret values 1
            end set local var Monster (4 0)


[78] var monster = Monster("monster-01.png", { // create our monster

            begin set local var
              begin call
                get local var Monster (4 0)
                begin params 2
                  push const string "monster-01.png"
                  ,
                  begin object 5

[79] walkRight 	= { start = 0, frames = 17, delay = 0.08, cols = 9, rows = 10 }

                    begin set by name
                      begin object 5
                        begin set by name
                          push const number 0
                        end set by name: [start]
                        ,
                        begin set by name
                          push const number 17
                        end set by name: [frames]
                        ,
                        begin set by name
                          push const number 0.08
                        end set by name: [delay]
                        ,
                        begin set by name
                          push const number 9
                        end set by name: [cols]
                        ,
                        begin set by name
                          push const number 10
                        end set by name: [rows]
                      end object
                    end set by name: [walkRight]
                    ,

[80] walkUp 		= { start = 17, frames = 13, delay = 0.08, cols = 9, rows = 10 }

                    begin set by name
                      begin object 5
                        begin set by name
                          push const number 17
                        end set by name: [start]
                        ,
                        begin set by name
                          push const number 13
                        end set by name: [frames]
                        ,
                        begin set by name
                          push const number 0.08
                        end set by name: [delay]
                        ,
                        begin set by name
                          push const number 9
                        end set by name: [cols]
                        ,
                        begin set by name
                          push const number 10
                        end set by name: [rows]
                      end object
                    end set by name: [walkUp]
                    ,

[81] walkDown 	= { start = 30, frames = 12, delay = 0.08, cols = 9, rows = 10 }

                    begin set by name
                      begin object 5
                        begin set by name
                          push const number 30
                        end set by name: [start]
                        ,
                        begin set by name
                          push const number 12
                        end set by name: [frames]
                        ,
                        begin set by name
                          push const number 0.08
                        end set by name: [delay]
                        ,
                        begin set by name
                          push const number 9
                        end set by name: [cols]
                        ,
                        begin set by name
                          push const number 10
                        end set by name: [rows]
                      end object
                    end set by name: [walkDown]
                    ,

[82] fightRight 	= { start = 42, frames = 12, delay = 0.08, cols = 9, rows = 10 }

                    begin set by name
                      begin object 5
                        begin set by name
                          push const number 42
                        end set by name: [start]
                        ,
                        begin set by name
                          push const number 12
                        end set by name: [frames]
                        ,
                        begin set by name
                          push const number 0.08
                        end set by name: [delay]
                        ,
                        begin set by name
                          push const number 9
                        end set by name: [cols]
                        ,
                        begin set by name
                          push const number 10
                        end set by name: [rows]
                      end object
                    end set by name: [fightRight]
                    ,

[83] dieRight 	= { start = 67, frames = 17, delay = 0.08, cols = 9, rows = 10 }

                    begin set by name
                      begin object 5
                        begin set by name
                          push const number 67
                        end set by name: [start]
                        ,
                        begin set by name
                          push const number 17
                        end set by name: [frames]
                        ,
                        begin set by name
                          push const number 0.08
                        end set by name: [delay]
                        ,
                        begin set by name
                          push const number 9
                        end set by name: [cols]
                        ,
                        begin set by name
                          push const number 10
                        end set by name: [rows]
                      end object
                    end set by name: [dieRight]
                  end object
                end params ret values 2
              end call ret values 1
            end set local var monster (5 0)


[85] monster.x = this.width * math.random(0.2, 0.8)

            begin set property
              begin operator *
                begin get property
                  push this
                  push const string "width"
                end get property ret values 1
                begin call method
                  get env var math
                  begin params 3
                    push const string "random"
                    ,
                    push const number 0.2
                    ,
                    push const number 0.8
                  end params ret values 3
                end call method ret values 1
              end operator *
              get local var auto create monster (5 0)
              push const string "x"
            end set property ret values 0


[86] monster.y = this.height * math.random(0.2, 0.8)

            begin set property
              begin operator *
                begin get property
                  push this
                  push const string "height"
                end get property ret values 1
                begin call method
                  get env var math
                  begin params 3
                    push const string "random"
                    ,
                    push const number 0.2
                    ,
                    push const number 0.8
                  end params ret values 3
                end call method ret values 1
              end operator *
              get local var auto create monster (5 0)
              push const string "y"
            end set property ret values 0


[87] monster.scale = 1.5 // scale monster to make them bigger

            begin set property
              push const number 1.5
              get local var auto create monster (5 0)
              push const string "scale"
            end set property ret values 0


[88] this.insert(monster) // insert monster to the scene

            begin call method
              push this
              begin params 2
                push const string "insert"
                ,
                get local var monster (5 0)
              end params ret values 2
            end call method ret values 0


[90] this.addEventListener("touch", function(touch){

            begin call method
              push this
              begin params 3
                push const string "addEventListener"
                ,
                push const string "touch"
                ,
                begin function
                  begin locals, total 3
                    0 touch (param)
                    1 _E
                    2 _G
                  end locals

[91] monster.move(touch.x, touch.y)

                  begin call method
                    get local var monster (5 1)
                    begin params 3
                      push const string "move"
                      ,
                      begin get property
                        get local var touch (0 0 param)
                        push const string "x"
                      end get property ret values 1
                      ,
                      begin get property
                        get local var touch (0 0 param)
                        push const string "y"
                      end get property ret values 1
                    end params ret values 3
                  end call method ret values 0
                end function
              end params ret values 3
            end call method ret values 0
          end function
        end set by name: [__construct]
      end object
    end extends ret values 1
  end set env var MyScene


[96] director.scene = MyScene()	// create and set our game scene

  begin set property
    begin call method
      get local var _E (0 0)
      begin params 1
        push const string "MyScene"
      end params ret values 1
    end call method ret values 1
    get local var auto create director (2 0)
    push const string "scene"
  end set property ret values 0

  begin code list
    begin return
      get local var _E (0 0)
    end return values 1
  end code list ret values 0
end function
