
[FILE] raw://../prog-os/bitmapfont.os
[1] _E = extends _E {}

begin function
  begin locals, total 2
    0 _E
    1 _G
  end locals
  begin set local var
    begin extends
      get local var _E (0 0)
      begin object 0
      end object
    end extends ret values 1
  end set local var _E (0 0)


[2] _G.BitmapFont = _E

  begin set property
    get local var _E (0 0)
    get local var auto create _G (1 0)
    push const string "BitmapFont"
  end set property ret values 0


[4] function parseConfig(filename){

  begin set env var
    begin function
      begin locals, total 17
        0 filename (param)
        1 _E
        2 _G
        3 tokens
        4 error
        5 token
        6 next_index
        7 readToken
        8 expectStr
        9 isNextType
        10 readValues
        11 readProperies
        12 readChars
        13 readKernings
        14 config
      end locals

[5] var tokens = LangTokenizer.parseFile(filename)

      begin set local var
        begin call method
          get env var LangTokenizer
          begin params 2
            push const string "parseFile"
            ,
            get local var filename (0 0 param)
          end params ret values 2
        end call method ret values 1
      end set local var tokens (3 0)


[7] var error, token

      begin params 2
        new local var error (4 0)
        ,
        new local var token (5 0)
      end params ret values 0


[8] var next_index = 0

      begin set local var
        push const number 0
      end set local var next_index (6 0)


[9] var function readToken(){ return error ? null : tokens[next_index++] }

      begin set local var
        begin function
          begin locals, total 3
            0 _E
            1 _G
            2 #temp
          end locals
          begin return
            begin question
              begin bool exp
                get local var error (4 1)
              end bool exp
              begin then value
                const null
              end then value
              begin else value
                begin get property
                  get local var tokens (3 1)
                  begin code list
                    begin set local var
                      get local var next_index (6 1)
                    end set local var #temp (2 0)

                    begin set local var
                      begin operator +
                        get local var next_index (6 1)
                        push const number 1
                      end operator +
                    end set local var next_index (6 1)

                    get local var #temp (2 0)
                  end code list ret values 1
                end get property ret values 1
              end else value
            end question ret values 1
          end return values 1
        end function
      end set local var readToken (7 0)


[10] var function expectStr(str){

      begin set local var
        begin function
          begin locals, total 4
            0 str (param)
            1 _E
            2 _G
            3 token
          end locals

[11] var token = readToken()

          begin set local var
            begin call
              get local var readToken (7 1)
              begin params 0
              end params ret values 0
            end call ret values 1
          end set local var token (3 0)


[12] if(token.str != str){

          begin if
            begin bool exp
              begin logic !=
                begin get property
                  get local var token (3 0)
                  push const string "str"
                end get property ret values 1
                get local var str (0 0 param)
              end logic !=
            end bool exp
            begin then

[13] print "expect str ERR "..str.." token "..token.." error "..error.." next index "..next_index.." tokens "..#tokens

              begin scope
                begin call method
                  get local var _E (1 0)
                  begin params 2
                    push const string "print"
                    ,
                    begin operator ..
                      begin operator ..
                        begin operator ..
                          begin operator ..
                            begin operator ..
                              begin operator ..
                                begin operator ..
                                  begin operator ..
                                    begin operator ..
                                      push const string "expect str ERR "
                                      get local var str (0 0 param)
                                    end operator ..
                                    push const string " token "
                                  end operator ..
                                  get local var token (3 0)
                                end operator ..
                                push const string " error "
                              end operator ..
                              get local var error (4 1)
                            end operator ..
                            push const string " next index "
                          end operator ..
                          get local var next_index (6 1)
                        end operator ..
                        push const string " tokens "
                      end operator ..
                      begin length
                        get local var tokens (3 1)
                      end length
                    end operator ..
                  end params ret values 2
                end call method ret values 0


[14] error = "expect str: "..str

                begin set local var
                  begin operator ..
                    push const string "expect str: "
                    get local var str (0 0 param)
                  end operator ..
                end set local var error (4 1)


[15] return

                return
              end scope ret values 0
            end then
          end if ret values 0


[17] return token

          begin code list
            begin return
              get local var token (3 0)
            end return values 1
          end code list ret values 0
        end function
      end set local var expectStr (8 0)


[19] var function isNextType(){

      begin set local var
        begin function
          begin locals, total 9
            0 _E
            1 _G
            2 save_error
            3 save_index
          end locals

[20] var save_error = error

          begin set local var
            get local var error (4 1)
          end set local var save_error (2 0)


[21] var save_index = next_index

          begin set local var
            get local var next_index (6 1)
          end set local var save_index (3 0)


[22] for(var i, arg in arguments){

          begin scope
            begin locals 4
              4 i
              5 arg
              7 #func
              8 #valid
            end locals
            new local var i (4 0)

            new local var arg (5 0)

            new local var #func (7 0 temp)

            new local var #valid (8 0 temp)

            begin code list
              begin set local var
                begin call method
                  push arguments
                  begin params 1
                    push const string "__iter"
                  end params ret values 1
                end call method ret values 1
              end set local var #func (7 0 temp)

              begin loop
                begin set local var
                  begin set local var
                    begin set local var
                      begin call
                        get local var #func (7 0 temp)
                        begin params 0
                        end params ret values 0
                      end call ret values 3
                    end set local var arg (5 0)
                  end set local var i (4 0)
                end set local var #valid (8 0 temp)

                begin if
                  begin bool exp
                    begin logic not
                      get local var #valid (8 0 temp)
                    end logic not
                  end bool exp
                  begin then
                    break
                  end then
                end if ret values 0


[23] var token = readToken()

                begin scope
                  begin locals 1
                    6 token
                  end locals
                  begin set local var
                    begin call
                      get local var readToken (7 1)
                      begin params 0
                      end params ret values 0
                    end call ret values 1
                  end set local var token (6 0)


[25] if(token.type != arg){

                  begin if
                    begin bool exp
                      begin logic !=
                        begin get property
                          get local var token (6 0)
                          push const string "type"
                        end get property ret values 1
                        get local var arg (5 0)
                      end logic !=
                    end bool exp
                    begin then

[27] error = save_error

                      begin scope
                        begin set local var
                          get local var save_error (2 0)
                        end set local var error (4 1)


[28] next_index = save_index

                        begin set local var
                          get local var save_index (3 0)
                        end set local var next_index (6 1)


[29] return false

                        begin code list
                          begin return
                            const false
                          end return values 1
                        end code list ret values 0
                      end scope ret values 0
                    end then
                  end if ret values 0
                end scope ret values 0
              end loop ret values 0
            end code list ret values 0
          end scope ret values 0


[33] error = save_error

          begin set local var
            get local var save_error (2 0)
          end set local var error (4 1)


[34] next_index = save_index

          begin set local var
            get local var save_index (3 0)
          end set local var next_index (6 1)


[35] return true

          begin code list
            begin return
              const true
            end return values 1
          end code list ret values 0
        end function
      end set local var isNextType (9 0)


[37] var function readValues(){

      begin set local var
        begin function
          begin locals, total 4
            0 _E
            1 _G
            2 values
          end locals

[38] var values = []

          begin set local var
            begin array 0
            end array
          end set local var values (2 0)


[39] for(;;){

          begin scope
            nop

            begin loop

[40] var token = readToken()

              begin scope
                begin locals 1
                  3 token
                end locals
                begin set local var
                  begin call
                    get local var readToken (7 1)
                    begin params 0
                    end params ret values 0
                  end call ret values 1
                end set local var token (3 0)


[41] if(!token) return;

                begin if
                  begin bool exp
                    begin logic not
                      get local var token (3 0)
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[42] values.push(token.str)

                begin call method
                  get local var values (2 0)
                  begin params 2
                    push const string "push"
                    ,
                    begin get property
                      get local var token (3 0)
                      push const string "str"
                    end get property ret values 1
                  end params ret values 2
                end call method ret values 0


[43] if(!isNextType(LangTokenizer.TOKEN_TYPE_OPERATOR)) return #values > 1 ? values : values[0];

                begin if
                  begin bool exp
                    begin logic not
                      begin call
                        get local var isNextType (9 1)
                        begin params 1
                          begin get property
                            get env var LangTokenizer
                            push const string "TOKEN_TYPE_OPERATOR"
                          end get property ret values 1
                        end params ret values 1
                      end call ret values 1
                    end logic not
                  end bool exp
                  begin then
                    begin code list
                      begin return
                        begin question
                          begin bool exp
                            begin logic >
                              begin length
                                get local var values (2 0)
                              end length
                              push const number 1
                            end logic >
                          end bool exp
                          begin then value
                            get local var values (2 0)
                          end then value
                          begin else value
                            begin get property
                              get local var values (2 0)
                              push const number 0
                            end get property ret values 1
                          end else value
                        end question ret values 1
                      end return values 1
                    end code list ret values 0
                  end then
                end if ret values 0


[44] if(!expectStr(",")) return;

                begin if
                  begin bool exp
                    begin logic not
                      begin call
                        get local var expectStr (8 1)
                        begin params 1
                          push const string ","
                        end params ret values 1
                      end call ret values 1
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0
              end scope ret values 0


[39] for(;;){

              nop
            end loop ret values 0
          end scope ret values 0
        end function
      end set local var readValues (10 0)


[47] var function readProperies(){

      begin set local var
        begin function
          begin locals, total 5
            0 _E
            1 _G
            2 props
          end locals

[48] var props = {}

          begin set local var
            begin object 0
            end object
          end set local var props (2 0)


[49] for(; isNextType(LangTokenizer.TOKEN_TYPE_NAME, LangTokenizer.TOKEN_TYPE_OPERATOR); ){

          begin scope
            nop

            begin loop
              begin if
                begin bool exp
                  begin logic not
                    begin call
                      get local var isNextType (9 1)
                      begin params 2
                        begin get property
                          get env var LangTokenizer
                          push const string "TOKEN_TYPE_NAME"
                        end get property ret values 1
                        ,
                        begin get property
                          get env var LangTokenizer
                          push const string "TOKEN_TYPE_OPERATOR"
                        end get property ret values 1
                      end params ret values 2
                    end call ret values 1
                  end logic not
                end bool exp
                begin then
                  break
                end then
              end if ret values 0


[50] var name = readToken()

              begin scope
                begin locals 2
                  3 name
                  4 values
                end locals
                begin set local var
                  begin call
                    get local var readToken (7 1)
                    begin params 0
                    end params ret values 0
                  end call ret values 1
                end set local var name (3 0)


[51] if(!expectStr("=")) return;

                begin if
                  begin bool exp
                    begin logic not
                      begin call
                        get local var expectStr (8 1)
                        begin params 1
                          push const string "="
                        end params ret values 1
                      end call ret values 1
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[52] var values = readValues()

                begin set local var
                  begin call
                    get local var readValues (10 1)
                    begin params 0
                    end params ret values 0
                  end call ret values 1
                end set local var values (4 0)


[54] if(!values) return;

                begin if
                  begin bool exp
                    begin logic not
                      get local var values (4 0)
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[55] props[name.str] = values

                begin set property
                  get local var values (4 0)
                  get local var auto create props (2 0)
                  begin get property
                    get local var name (3 0)
                    push const string "str"
                  end get property ret values 1
                end set property ret values 0
              end scope ret values 0


[49] for(; isNextType(LangTokenizer.TOKEN_TYPE_NAME, LangTokenizer.TOKEN_TYPE_OPERATOR); ){

              nop
            end loop ret values 0
          end scope ret values 0


[59] return props;

          begin code list
            begin return
              get local var props (2 0)
            end return values 1
          end code list ret values 0
        end function
      end set local var readProperies (11 0)


[61] var function readChars(){

      begin set local var
        begin function
          begin locals, total 6
            0 _E
            1 _G
            2 count
            3 chars
          end locals

[62] if(!expectStr("count") || !expectStr("=")) return;

          begin if
            begin bool exp
              begin logic ||
                begin logic not
                  begin call
                    get local var expectStr (8 1)
                    begin params 1
                      push const string "count"
                    end params ret values 1
                  end call ret values 1
                end logic not
                begin logic not
                  begin call
                    get local var expectStr (8 1)
                    begin params 1
                      push const string "="
                    end params ret values 1
                  end call ret values 1
                end logic not
              end logic ||
            end bool exp
            begin then
              return
            end then
          end if ret values 0


[63] var count = readToken()

          begin set local var
            begin call
              get local var readToken (7 1)
              begin params 0
              end params ret values 0
            end call ret values 1
          end set local var count (2 0)


[64] if(!count) return;

          begin if
            begin bool exp
              begin logic not
                get local var count (2 0)
              end logic not
            end bool exp
            begin then
              return
            end then
          end if ret values 0


[65] count = numberof count.str

          begin set local var
            begin numberof
              begin get property
                get local var count (2 0)
                push const string "str"
              end get property ret values 1
            end numberof
          end set local var count (2 0)


[66] var chars = {}

          begin set local var
            begin object 0
            end object
          end set local var chars (3 0)


[67] for(var i = 0; i < count; ++i){

          begin scope
            begin locals 1
              4 i
            end locals
            begin set local var
              push const number 0
            end set local var i (4 0)

            begin loop
              begin if
                begin bool exp
                  begin logic not
                    begin logic <
                      get local var i (4 0)
                      get local var count (2 0)
                    end logic <
                  end logic not
                end bool exp
                begin then
                  break
                end then
              end if ret values 0


[68] if(!expectStr("char")) return;

              begin scope
                begin locals 1
                  5 props
                end locals
                begin if
                  begin bool exp
                    begin logic not
                      begin call
                        get local var expectStr (8 1)
                        begin params 1
                          push const string "char"
                        end params ret values 1
                      end call ret values 1
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[69] var props = readProperies()

                begin set local var
                  begin call
                    get local var readProperies (11 1)
                    begin params 0
                    end params ret values 0
                  end call ret values 1
                end set local var props (5 0)


[70] if(!props) return;

                begin if
                  begin bool exp
                    begin logic not
                      get local var props (5 0)
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[71] chars[props.id] = props

                begin set property
                  get local var props (5 0)
                  get local var auto create chars (3 0)
                  begin get property
                    get local var props (5 0)
                    push const string "id"
                  end get property ret values 1
                end set property ret values 0
              end scope ret values 0


[67] for(var i = 0; i < count; ++i){

              begin code list
                begin set local var
                  begin operator +
                    get local var i (4 0)
                    push const number 1
                  end operator +
                end set local var i (4 0)
              end code list ret values 0
            end loop ret values 0
          end scope ret values 0


[73] return chars

          begin code list
            begin return
              get local var chars (3 0)
            end return values 1
          end code list ret values 0
        end function
      end set local var readChars (12 0)


[75] var function readKernings(){

      begin set local var
        begin function
          begin locals, total 6
            0 _E
            1 _G
            2 count
            3 kernings
          end locals

[76] if(!expectStr("count") || !expectStr("=")) return;

          begin if
            begin bool exp
              begin logic ||
                begin logic not
                  begin call
                    get local var expectStr (8 1)
                    begin params 1
                      push const string "count"
                    end params ret values 1
                  end call ret values 1
                end logic not
                begin logic not
                  begin call
                    get local var expectStr (8 1)
                    begin params 1
                      push const string "="
                    end params ret values 1
                  end call ret values 1
                end logic not
              end logic ||
            end bool exp
            begin then
              return
            end then
          end if ret values 0


[77] var count = readToken()

          begin set local var
            begin call
              get local var readToken (7 1)
              begin params 0
              end params ret values 0
            end call ret values 1
          end set local var count (2 0)


[78] if(!count) return;

          begin if
            begin bool exp
              begin logic not
                get local var count (2 0)
              end logic not
            end bool exp
            begin then
              return
            end then
          end if ret values 0


[79] count = numberof count.str

          begin set local var
            begin numberof
              begin get property
                get local var count (2 0)
                push const string "str"
              end get property ret values 1
            end numberof
          end set local var count (2 0)


[80] var kernings = []

          begin set local var
            begin array 0
            end array
          end set local var kernings (3 0)


[81] for(var i = 0; i < count; ++i){

          begin scope
            begin locals 1
              4 i
            end locals
            begin set local var
              push const number 0
            end set local var i (4 0)

            begin loop
              begin if
                begin bool exp
                  begin logic not
                    begin logic <
                      get local var i (4 0)
                      get local var count (2 0)
                    end logic <
                  end logic not
                end bool exp
                begin then
                  break
                end then
              end if ret values 0


[82] if(!expectStr("kerning")) return;

              begin scope
                begin locals 1
                  5 props
                end locals
                begin if
                  begin bool exp
                    begin logic not
                      begin call
                        get local var expectStr (8 1)
                        begin params 1
                          push const string "kerning"
                        end params ret values 1
                      end call ret values 1
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[83] var props = readProperies()

                begin set local var
                  begin call
                    get local var readProperies (11 1)
                    begin params 0
                    end params ret values 0
                  end call ret values 1
                end set local var props (5 0)


[84] if(!props) return;

                begin if
                  begin bool exp
                    begin logic not
                      get local var props (5 0)
                    end logic not
                  end bool exp
                  begin then
                    return
                  end then
                end if ret values 0


[85] kernings[] = props

                begin set dim
                  get local var props (5 0)
                  get local var kernings (3 0)
                  begin params 0
                  end params ret values 0
                end set dim ret values 0
              end scope ret values 0


[81] for(var i = 0; i < count; ++i){

              begin code list
                begin set local var
                  begin operator +
                    get local var i (4 0)
                    push const number 1
                  end operator +
                end set local var i (4 0)
              end code list ret values 0
            end loop ret values 0
          end scope ret values 0


[87] return kernings

          begin code list
            begin return
              get local var kernings (3 0)
            end return values 1
          end code list ret values 0
        end function
      end set local var readKernings (13 0)


[90] var config = {}

      begin set local var
        begin object 0
        end object
      end set local var config (14 0)


[91] for(;;){

      begin scope
        nop

        begin loop

[92] token = readToken()

          begin scope
            begin set local var
              begin call
                get local var readToken (7 0)
                begin params 0
                end params ret values 0
              end call ret values 1
            end set local var token (5 0)


[93] if(token.str == "info" || token.str == "common" || token.str == "page"){

            begin if
              begin bool exp
                begin logic ||
                  begin logic ||
                    begin logic ==
                      begin get property
                        get local var token (5 0)
                        push const string "str"
                      end get property ret values 1
                      push const string "info"
                    end logic ==
                    begin logic ==
                      begin get property
                        get local var token (5 0)
                        push const string "str"
                      end get property ret values 1
                      push const string "common"
                    end logic ==
                  end logic ||
                  begin logic ==
                    begin get property
                      get local var token (5 0)
                      push const string "str"
                    end get property ret values 1
                    push const string "page"
                  end logic ==
                end logic ||
              end bool exp
              begin then

[94] config[token.str] = readProperies()

                begin scope
                  begin set property
                    begin call
                      get local var readProperies (11 0)
                      begin params 0
                      end params ret values 0
                    end call ret values 1
                    get local var auto create config (14 0)
                    begin get property
                      get local var token (5 0)
                      push const string "str"
                    end get property ret values 1
                  end set property ret values 0


[95] if(!config[token.str]) return;

                  begin if
                    begin bool exp
                      begin logic not
                        begin get property
                          get local var config (14 0)
                          begin get property
                            get local var token (5 0)
                            push const string "str"
                          end get property ret values 1
                        end get property ret values 1
                      end logic not
                    end bool exp
                    begin then
                      return
                    end then
                  end if ret values 0


[96] continue

                  continue
                end scope ret values 0
              end then
            end if ret values 0


[98] if(token.str == "chars"){

            begin if
              begin bool exp
                begin logic ==
                  begin get property
                    get local var token (5 0)
                    push const string "str"
                  end get property ret values 1
                  push const string "chars"
                end logic ==
              end bool exp
              begin then

[99] var chars = readChars();

                begin scope
                  begin locals 1
                    15 chars
                  end locals
                  begin set local var
                    begin call
                      get local var readChars (12 0)
                      begin params 0
                      end params ret values 0
                    end call ret values 1
                  end set local var chars (15 0)


[100] if(!chars) return;

                  begin if
                    begin bool exp
                      begin logic not
                        get local var chars (15 0)
                      end logic not
                    end bool exp
                    begin then
                      return
                    end then
                  end if ret values 0


[101] config.chars = chars

                  begin set property
                    get local var chars (15 0)
                    get local var auto create config (14 0)
                    push const string "chars"
                  end set property ret values 0


[102] continue

                  continue
                end scope ret values 0
              end then
            end if ret values 0


[104] if(token.str == "kernings"){

            begin if
              begin bool exp
                begin logic ==
                  begin get property
                    get local var token (5 0)
                    push const string "str"
                  end get property ret values 1
                  push const string "kernings"
                end logic ==
              end bool exp
              begin then

[105] var kernings = readKernings();

                begin scope
                  begin locals 1
                    16 kernings
                  end locals
                  begin set local var
                    begin call
                      get local var readKernings (13 0)
                      begin params 0
                      end params ret values 0
                    end call ret values 1
                  end set local var kernings (16 0)


[106] if(!kernings) return;

                  begin if
                    begin bool exp
                      begin logic not
                        get local var kernings (16 0)
                      end logic not
                    end bool exp
                    begin then
                      return
                    end then
                  end if ret values 0


[107] config.kernings = kernings

                  begin set property
                    get local var kernings (16 0)
                    get local var auto create config (14 0)
                    push const string "kernings"
                  end set property ret values 0


[108] continue

                  continue
                end scope ret values 0
              end then
            end if ret values 0


[110] print "cur token "..token.." next index "..next_index; print "config "..config; terminate()

            begin call method
              get local var _E (1 0)
              begin params 2
                push const string "print"
                ,
                begin operator ..
                  begin operator ..
                    begin operator ..
                      push const string "cur token "
                      get local var token (5 0)
                    end operator ..
                    push const string " next index "
                  end operator ..
                  get local var next_index (6 0)
                end operator ..
              end params ret values 2
            end call method ret values 0

            begin call method
              get local var _E (1 0)
              begin params 2
                push const string "print"
                ,
                begin operator ..
                  push const string "config "
                  get local var config (14 0)
                end operator ..
              end params ret values 2
            end call method ret values 0

            begin call method
              get local var _E (1 0)
              begin params 1
                push const string "terminate"
              end params ret values 1
            end call method ret values 0
          end scope ret values 0


[91] for(;;){

          nop
        end loop ret values 0
      end scope ret values 0


[112] return config

      begin code list
        begin return
          get local var config (14 0)
        end return values 1
      end code list ret values 0
    end function
  end set env var parseConfig

  begin code list
    begin return
      get local var _E (0 0)
    end return values 1
  end code list ret values 0
end function
