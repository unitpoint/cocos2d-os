
[FILE] raw://../prog-os/main.os
[1] var director = require("director")

begin function
  begin locals, total 3
    0 _E
    1 _G
    2 director
  end locals
  begin set local var
    begin call method
      get local var _E (0 0)
      begin params 2
        push const string "require"
        ,
        push const string "director"
      end params ret values 2
    end call method ret values 1
  end set local var director (2 0)


[3] print "Hello World!" // please see all printed messages here: assets-ram/output.txt

  begin call method
    get local var _E (0 0)
    begin params 2
      push const string "print"
      ,
      push const string "Hello World!"
    end params ret values 2
  end call method ret values 0


[5] MyScene = extends Scene {

  begin set env var
    begin extends
      get env var Scene
      begin object 1

[6] __construct = function(){

        begin set by name
          begin function
            begin locals, total 5
              0 _E
              1 _G
              2 bg
              3 spring
              4 message
            end locals

[7] super() // call constructor of class we extend

            begin call
              super
              begin params 0
              end params ret values 0
            end call ret values 0


[9] var bg = Image("bg.jpg") 	// create background image

            begin set local var
              begin call method
                get local var _E (0 0)
                begin params 2
                  push const string "Image"
                  ,
                  push const string "bg.jpg"
                end params ret values 2
              end call method ret values 1
            end set local var bg (2 0)


[10] bg.x = this.width / 2		// locate it at center of scene

            begin set property
              begin operator /
                begin get property
                  push this
                  push const string "width"
                end get property ret values 1
                push const number 2
              end operator /
              get local var auto create bg (2 0)
              push const string "x"
            end set property ret values 0


[11] bg.y = this.height / 2

            begin set property
              begin operator /
                begin get property
                  push this
                  push const string "height"
                end get property ret values 1
                push const number 2
              end operator /
              get local var auto create bg (2 0)
              push const string "y"
            end set property ret values 0


[12] bg.scale = math.max(this.width / bg.width, this.height / bg.height)

            begin set property
              begin call method
                get env var math
                begin params 3
                  push const string "max"
                  ,
                  begin operator /
                    begin get property
                      push this
                      push const string "width"
                    end get property ret values 1
                    begin get property
                      get local var bg (2 0)
                      push const string "width"
                    end get property ret values 1
                  end operator /
                  ,
                  begin operator /
                    begin get property
                      push this
                      push const string "height"
                    end get property ret values 1
                    begin get property
                      get local var bg (2 0)
                      push const string "height"
                    end get property ret values 1
                  end operator /
                end params ret values 3
              end call method ret values 1
              get local var auto create bg (2 0)
              push const string "scale"
            end set property ret values 0


[13] this.insert(bg)				// insert the background image to the scene

            begin call method
              push this
              begin params 2
                push const string "insert"
                ,
                get local var bg (2 0)
              end params ret values 2
            end call method ret values 0


[15] var spring = Image("spring.png")

            begin set local var
              begin call method
                get local var _E (0 0)
                begin params 2
                  push const string "Image"
                  ,
                  push const string "spring.png"
                end params ret values 2
              end call method ret values 1
            end set local var spring (3 0)


[16] spring.anchor = {x=0.05 y=0.5}

            begin set property
              begin object 2
                begin set by name
                  push const number 0.05
                end set by name: [x]
                ,
                begin set by name
                  push const number 0.5
                end set by name: [y]
              end object
              get local var auto create spring (3 0)
              push const string "anchor"
            end set property ret values 0


[17] spring.x, spring.y = this.width/2, this.height/2

            begin set property
              begin set property
                begin params 2
                  begin operator /
                    begin get property
                      push this
                      push const string "width"
                    end get property ret values 1
                    push const number 2
                  end operator /
                  ,
                  begin operator /
                    begin get property
                      push this
                      push const string "height"
                    end get property ret values 1
                    push const number 2
                  end operator /
                end params ret values 2
                get local var auto create spring (3 0)
                push const string "y"
              end set property ret values 1
              get local var auto create spring (3 0)
              push const string "x"
            end set property ret values 0


[18] spring.addEventListener("touch", function(touch){

            begin call method
              get local var spring (3 0)
              begin params 3
                push const string "addEventListener"
                ,
                push const string "touch"
                ,
                begin function
                  begin locals, total 9
                    0 touch (param)
                    1 _E
                    2 _G
                  end locals

[19] if(touch.phase == "start"){

                  begin if
                    begin bool exp
                      begin logic ==
                        begin get property
                          get local var touch (0 0 param)
                          push const string "phase"
                        end get property ret values 1
                        push const string "start"
                      end logic ==
                    end bool exp
                    begin then

[20] if("elasticTransition" in this){

                      begin scope
                        begin locals 2
                          3 dx
                          4 dy
                        end locals
                        begin if
                          begin bool exp
                            begin in
                              push const string "elasticTransition"
                              push this
                            end in
                          end bool exp
                          begin then

[21] this.elasticTransition.remove()

                            begin scope
                              begin call method
                                begin get property
                                  push this
                                  push const string "elasticTransition"
                                end get property ret values 1
                                begin params 1
                                  push const string "remove"
                                end params ret values 1
                              end call method ret values 0


[22] delete this.elasticTransition

                              begin delete
                                push this
                                push const string "elasticTransition"
                              end delete
                            end scope ret values 0
                          end then
                        end if ret values 0


[24] var dx = touch.x - this.x

                        begin set local var
                          begin operator -
                            begin get property
                              get local var touch (0 0 param)
                              push const string "x"
                            end get property ret values 1
                            begin get property
                              push this
                              push const string "x"
                            end get property ret values 1
                          end operator -
                        end set local var dx (3 0)


[25] var dy = touch.y - this.y

                        begin set local var
                          begin operator -
                            begin get property
                              get local var touch (0 0 param)
                              push const string "y"
                            end get property ret values 1
                            begin get property
                              push this
                              push const string "y"
                            end get property ret values 1
                          end operator -
                        end set local var dy (4 0)


[26] this.len0 = (dx*dx + dy*dy)**0.5 // sqrt is equal to the power of 0.5

                        begin set property
                          begin operator **
                            begin operator +
                              begin operator *
                                get local var dx (3 0)
                                get local var dx (3 0)
                              end operator *
                              begin operator *
                                get local var dy (4 0)
                                get local var dy (4 0)
                              end operator *
                            end operator +
                            push const number 0.5
                          end operator **
                          push this
                          push const string "len0"
                        end set property ret values 0


[27] this.scale0 = this.scaleX

                        begin set property
                          begin get property
                            push this
                            push const string "scaleX"
                          end get property ret values 1
                          push this
                          push const string "scale0"
                        end set property ret values 0


[28] this.r0 = math.deg(math.atan2(dy, dx)) - this.rotation

                        begin set property
                          begin operator -
                            begin call method
                              get env var math
                              begin params 2
                                push const string "deg"
                                ,
                                begin call method
                                  get env var math
                                  begin params 3
                                    push const string "atan2"
                                    ,
                                    get local var dy (4 0)
                                    ,
                                    get local var dx (3 0)
                                  end params ret values 3
                                end call method ret values 1
                              end params ret values 2
                            end call method ret values 1
                            begin get property
                              push this
                              push const string "rotation"
                            end get property ret values 1
                          end operator -
                          push this
                          push const string "r0"
                        end set property ret values 0
                      end scope ret values 0
                    end then
                    begin else

[29] }else if(touch.phase == "move"){

                      begin if
                        begin bool exp
                          begin logic ==
                            begin get property
                              get local var touch (0 0 param)
                              push const string "phase"
                            end get property ret values 1
                            push const string "move"
                          end logic ==
                        end bool exp
                        begin then

[30] var dx = touch.x - this.x

                          begin scope
                            begin locals 4
                              5 dx
                              6 dy
                              7 len
                              8 rotation
                            end locals
                            begin set local var
                              begin operator -
                                begin get property
                                  get local var touch (0 0 param)
                                  push const string "x"
                                end get property ret values 1
                                begin get property
                                  push this
                                  push const string "x"
                                end get property ret values 1
                              end operator -
                            end set local var dx (5 0)


[31] var dy = touch.y - this.y

                            begin set local var
                              begin operator -
                                begin get property
                                  get local var touch (0 0 param)
                                  push const string "y"
                                end get property ret values 1
                                begin get property
                                  push this
                                  push const string "y"
                                end get property ret values 1
                              end operator -
                            end set local var dy (6 0)


[32] var len = (dx*dx + dy*dy)**0.5

                            begin set local var
                              begin operator **
                                begin operator +
                                  begin operator *
                                    get local var dx (5 0)
                                    get local var dx (5 0)
                                  end operator *
                                  begin operator *
                                    get local var dy (6 0)
                                    get local var dy (6 0)
                                  end operator *
                                end operator +
                                push const number 0.5
                              end operator **
                            end set local var len (7 0)


[33] var rotation = math.deg(math.atan2(dy, dx))

                            begin set local var
                              begin call method
                                get env var math
                                begin params 2
                                  push const string "deg"
                                  ,
                                  begin call method
                                    get env var math
                                    begin params 3
                                      push const string "atan2"
                                      ,
                                      get local var dy (6 0)
                                      ,
                                      get local var dx (5 0)
                                    end params ret values 3
                                  end call method ret values 1
                                end params ret values 2
                              end call method ret values 1
                            end set local var rotation (8 0)


[34] this.rotation = rotation - this.r0

                            begin set property
                              begin operator -
                                get local var rotation (8 0)
                                begin get property
                                  push this
                                  push const string "r0"
                                end get property ret values 1
                              end operator -
                              push this
                              push const string "rotation"
                            end set property ret values 0


[35] this.scaleX = this.scale0 * len / this.len0

                            begin set property
                              begin operator /
                                begin operator *
                                  begin get property
                                    push this
                                    push const string "scale0"
                                  end get property ret values 1
                                  get local var len (7 0)
                                end operator *
                                begin get property
                                  push this
                                  push const string "len0"
                                end get property ret values 1
                              end operator /
                              push this
                              push const string "scaleX"
                            end set property ret values 0
                          end scope ret values 0
                        end then
                        begin else

[37] this.elasticTransition = this.transition {

                          begin scope
                            begin set property
                              begin call method
                                push this
                                begin params 2
                                  push const string "transition"
                                  ,
                                  begin object 4

[38] scaleX = 1

                                    begin set by name
                                      push const number 1
                                    end set by name: [scaleX]
                                    ,

[39] rotation = math.round(this.rotation / 90) * 90 // snap to angle

                                    begin set by name
                                      begin operator *
                                        begin call method
                                          get env var math
                                          begin params 2
                                            push const string "round"
                                            ,
                                            begin operator /
                                              begin get property
                                                push this
                                                push const string "rotation"
                                              end get property ret values 1
                                              push const number 90
                                            end operator /
                                          end params ret values 2
                                        end call method ret values 1
                                        push const number 90
                                      end operator *
                                    end set by name: [rotation]
                                    ,

[40] duration = 0.5

                                    begin set by name
                                      push const number 0.5
                                    end set by name: [duration]
                                    ,

[41] easy = Easy.outBack

                                    begin set by name
                                      begin get property
                                        get env var Easy
                                        push const string "outBack"
                                      end get property ret values 1
                                    end set by name: [easy]
                                  end object
                                end params ret values 2
                              end call method ret values 1

[37] this.elasticTransition = this.transition {

                              push this
                              push const string "elasticTransition"
                            end set property ret values 0
                          end scope ret values 0
                        end else
                      end if ret values 0
                    end else
                  end if ret values 0
                end function
              end params ret values 3
            end call method ret values 0


[45] this.insert(spring)

            begin call method
              push this
              begin params 2
                push const string "insert"
                ,
                get local var spring (3 0)
              end params ret values 2
            end call method ret values 0


[47] var message = Text("Elastic Transition")	// create message

            begin set local var
              begin call method
                get local var _E (0 0)
                begin params 2
                  push const string "Text"
                  ,
                  push const string "Elastic Transition"
                end params ret values 2
              end call method ret values 1
            end set local var message (4 0)


[48] message.x = this.width	// locate the message at right bottom corner

            begin set property
              begin get property
                push this
                push const string "width"
              end get property ret values 1
              get local var auto create message (4 0)
              push const string "x"
            end set property ret values 0


[49] message.y = this.height

            begin set property
              begin get property
                push this
                push const string "height"
              end get property ret values 1
              get local var auto create message (4 0)
              push const string "y"
            end set property ret values 0


[50] message.anchor = {x=1.05 y=1.05}

            begin set property
              begin object 2
                begin set by name
                  push const number 1.05
                end set by name: [x]
                ,
                begin set by name
                  push const number 1.05
                end set by name: [y]
              end object
              get local var auto create message (4 0)
              push const string "anchor"
            end set property ret values 0


[51] message.shadow = true	// we want shadow enabled

            begin set property
              const true
              get local var auto create message (4 0)
              push const string "shadow"
            end set property ret values 0


[52] this.insert(message)

            begin call method
              push this
              begin params 2
                push const string "insert"
                ,
                get local var message (4 0)
              end params ret values 2
            end call method ret values 0
          end function
        end set by name: [__construct]
      end object
    end extends ret values 1
  end set env var MyScene


[56] director.scene = MyScene()	// create and set our game scene

  begin set property
    begin call method
      get local var _E (0 0)
      begin params 1
        push const string "MyScene"
      end params ret values 1
    end call method ret values 1
    get local var auto create director (2 0)
    push const string "scene"
  end set property ret values 0

  begin code list
    begin return
      get local var _E (0 0)
    end return values 1
  end code list ret values 0
end function
