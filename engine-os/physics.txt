
[FILE] raw://../../engine-os/physics.os
[1] _E = extends _G {}

begin function
  begin locals, total 9
    0 _E
    1 _G
    2 world
    3 fixedTimeStep
    4 velocityIterations
    5 positionIterations
    6 timeAccumulator
    7 nodeSetX
    8 nodeSetY
  end locals
  begin set local var
    begin extends
      get local var _G (1 0)
      begin object 0
      end object
    end extends ret values 1
  end set local var _E (0 0)


[2] _G.physics = _E

  begin set property
    get local var _E (0 0)
    get local var auto create _G (1 0)
    push const string "physics"
  end set property ret values 0


[4] var world = b2World()

  begin set local var
    begin call method
      get local var _E (0 0)
      begin params 1
        push const string "b2World"
      end params ret values 1
    end call method ret values 1
  end set local var world (2 0)


[5] function get world(){ return world }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var world (2 1)
      end return values 1
    end function
  end set env var __get@world


[7] var fixedTimeStep = 1.0f / 60

  begin set local var
    push const number 0.0166667
  end set local var fixedTimeStep (3 0)


[8] var velocityIterations = 10

  begin set local var
    push const number 10
  end set local var velocityIterations (4 0)


[9] var positionIterations = 8

  begin set local var
    push const number 8
  end set local var positionIterations (5 0)


[10] var timeAccumulator = 0

  begin set local var
    push const number 0
  end set local var timeAccumulator (6 0)


[12] addEventListener("enterFrame", function(params){

  begin call method
    get local var _E (0 0)
    begin params 3
      push const string "addEventListener"
      ,
      push const string "enterFrame"
      ,
      begin function
        begin locals, total 3
          0 params (param)
          1 _E
          2 _G
        end locals

[13] timeAccumulator = timeAccumulator + params.deltaTime

        begin set local var
          begin operator +
            get local var timeAccumulator (6 1)
            begin get property
              get local var params (0 0 param)
              push const string "deltaTime"
            end get property ret values 1
          end operator +
        end set local var timeAccumulator (6 1)


[14] for(; timeAccumulator >= fixedTimeStep;){

        begin scope
          nop

          begin loop
            begin if
              begin bool exp
                begin logic not
                  begin logic >=
                    get local var timeAccumulator (6 1)
                    get local var fixedTimeStep (3 1)
                  end logic >=
                end logic not
              end bool exp
              begin then
                break
              end then
            end if ret values 0


[15] world.step(fixedTimeStep, velocityIterations, positionIterations)

            begin scope
              begin call method
                get local var world (2 1)
                begin params 4
                  push const string "step"
                  ,
                  get local var fixedTimeStep (3 1)
                  ,
                  get local var velocityIterations (4 1)
                  ,
                  get local var positionIterations (5 1)
                end params ret values 4
              end call method ret values 0


[16] timeAccumulator = timeAccumulator - fixedTimeStep

              begin set local var
                begin operator -
                  get local var timeAccumulator (6 1)
                  get local var fixedTimeStep (3 1)
                end operator -
              end set local var timeAccumulator (6 1)
            end scope ret values 0


[14] for(; timeAccumulator >= fixedTimeStep;){

            nop
          end loop ret values 0
        end scope ret values 0
      end function
    end params ret values 3
  end call method ret values 0


[20] function get velocityIterations(){ return velocityIterations }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var velocityIterations (4 1)
      end return values 1
    end function
  end set env var __get@velocityIterations


[21] function set velocityIterations(a){ velocityIterations = a }

  begin set env var
    begin function
      begin locals, total 3
        0 a (param)
        1 _E
        2 _G
      end locals
      begin set local var
        get local var a (0 0 param)
      end set local var velocityIterations (4 1)
    end function
  end set env var __set@velocityIterations


[23] function get positionIterations(){ return positionIterations }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var positionIterations (5 1)
      end return values 1
    end function
  end set env var __get@positionIterations


[24] function set positionIterations(a){ positionIterations = a }

  begin set env var
    begin function
      begin locals, total 3
        0 a (param)
        1 _E
        2 _G
      end locals
      begin set local var
        get local var a (0 0 param)
      end set local var positionIterations (5 1)
    end function
  end set env var __set@positionIterations


[26] function get fixedTimeStep(){ return fixedTimeStep }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var fixedTimeStep (3 1)
      end return values 1
    end function
  end set env var __get@fixedTimeStep


[27] function set fixedTimeStep(a){ fixedTimeStep = a }

  begin set env var
    begin function
      begin locals, total 3
        0 a (param)
        1 _E
        2 _G
      end locals
      begin set local var
        get local var a (0 0 param)
      end set local var fixedTimeStep (3 1)
    end function
  end set env var __set@fixedTimeStep


[29] function createBody(params){

  begin set env var
    begin function
      begin locals, total 3
        0 params (param)
        1 _E
        2 _G
      end locals

[30] return world.createBody(params)

      begin tail call method
        get local var world (2 1)
        begin params 2
          push const string "createBody"
          ,
          get local var params (0 0 param)
        end params ret values 2
      end tail call method
    end function
  end set env var createBody


[33] function destroyBody(params){

  begin set env var
    begin function
      begin locals, total 3
        0 params (param)
        1 _E
        2 _G
      end locals

[34] return world.destroyBody(params)

      begin tail call method
        get local var world (2 1)
        begin params 2
          push const string "destroyBody"
          ,
          get local var params (0 0 param)
        end params ret values 2
      end tail call method
    end function
  end set env var destroyBody


[37] Node.__object.merge {

  begin call method
    begin get property
      get env var Node
      push const string "__object"
    end get property ret values 1
    begin params 2
      push const string "merge"
      ,
      begin object 2

[38] __physicsUpdateInProgress = null

        begin set by name
          const null
        end set by name: [__physicsUpdateInProgress]
        ,

[39] __physicsBody = null

        begin set by name
          const null
        end set by name: [__physicsBody]
      end object
    end params ret values 2
  end call method ret values 0


[42] var nodeSetX = Node.__set@x

  begin set local var
    begin get property
      get env var Node
      push const string "__set@x"
    end get property ret values 1
  end set local var nodeSetX (7 0)


[43] var nodeSetY = Node.__set@y

  begin set local var
    begin get property
      get env var Node
      push const string "__set@y"
    end get property ret values 1
  end set local var nodeSetY (8 0)


[45] Node.merge {

  begin call method
    get env var Node
    begin params 2
      push const string "merge"
      ,
      begin object 6

[46] addPhysicsBody = function(params){

        begin set by name
          begin function
            begin locals, total 3
              0 params (param)
              1 _E
              2 _G
            end locals

[47] this.removePhysicsBody()

            begin call method
              push this
              begin params 1
                push const string "removePhysicsBody"
              end params ret values 1
            end call method ret values 0


[48] this.__physicsBody = world.createBody({}.merge(params, {

            begin set property
              begin call method
                get local var world (2 1)
                begin params 2
                  push const string "createBody"
                  ,
                  begin call method
                    begin object 0
                    end object
                    begin params 3
                      push const string "merge"
                      ,
                      get local var params (0 0 param)
                      ,
                      begin object 3

[49] x = this.x

                        begin set by name
                          begin get property
                            push this
                            push const string "x"
                          end get property ret values 1
                        end set by name: [x]
                        ,

[50] y = this.y

                        begin set by name
                          begin get property
                            push this
                            push const string "y"
                          end get property ret values 1
                        end set by name: [y]
                        ,

[51] angle = math.rad(this.rotation)

                        begin set by name
                          begin call method
                            get env var math
                            begin params 2
                              push const string "rad"
                              ,
                              begin get property
                                push this
                                push const string "rotation"
                              end get property ret values 1
                            end params ret values 2
                          end call method ret values 1
                        end set by name: [angle]
                      end object
                    end params ret values 3
                  end call method ret values 1
                end params ret values 2
              end call method ret values 1

[48] this.__physicsBody = world.createBody({}.merge(params, {

              push this
              push const string "__physicsBody"
            end set property ret values 0


[53] this.addEventListener("enterFrame", this.__updateNodePosition)

            begin call method
              push this
              begin params 3
                push const string "addEventListener"
                ,
                push const string "enterFrame"
                ,
                begin get property
                  push this
                  push const string "__updateNodePosition"
                end get property ret values 1
              end params ret values 3
            end call method ret values 0


[54] return this.physicsBody

            begin code list
              begin return
                begin get property
                  push this
                  push const string "physicsBody"
                end get property ret values 1
              end return values 1
            end code list ret values 0
          end function
        end set by name: [addPhysicsBody]
        ,

[56] removePhysicsBody = function(){

        begin set by name
          begin function
            begin locals, total 2
              0 _E
              1 _G
            end locals

[57] if(this.__physicsBody){

            begin if
              begin bool exp
                begin get property
                  push this
                  push const string "__physicsBody"
                end get property ret values 1
              end bool exp
              begin then

[58] this.removeEventListener("enterFrame", this.__updateNodePosition)

                begin scope
                  begin call method
                    push this
                    begin params 3
                      push const string "removeEventListener"
                      ,
                      push const string "enterFrame"
                      ,
                      begin get property
                        push this
                        push const string "__updateNodePosition"
                      end get property ret values 1
                    end params ret values 3
                  end call method ret values 0


[59] world.destroyBody(this.__physicsBody)

                  begin call method
                    get local var world (2 1)
                    begin params 2
                      push const string "destroyBody"
                      ,
                      begin get property
                        push this
                        push const string "__physicsBody"
                      end get property ret values 1
                    end params ret values 2
                  end call method ret values 0


[60] this.__physicsBody = null

                  begin set property
                    const null
                    push this
                    push const string "__physicsBody"
                  end set property ret values 0
                end scope ret values 0
              end then
            end if ret values 0
          end function
        end set by name: [removePhysicsBody]
        ,

[63] __updateNodePosition = function(){

        begin set by name
          begin function
            begin locals, total 3
              0 _E
              1 _G
              2 xf
            end locals

[64] var xf = this.__physicsBody.transform

            begin set local var
              begin get property
                begin get property
                  push this
                  push const string "__physicsBody"
                end get property ret values 1
                push const string "transform"
              end get property ret values 1
            end set local var xf (2 0)


[65] this.__physicsUpdateInProgress = true

            begin set property
              const true
              push this
              push const string "__physicsUpdateInProgress"
            end set property ret values 0


[66] this.x, this.y, this.rotation = xf.x, xf.y, math.deg(xf.angle)

            begin set property
              begin set property
                begin set property
                  begin params 3
                    begin get property
                      get local var xf (2 0)
                      push const string "x"
                    end get property ret values 1
                    ,
                    begin get property
                      get local var xf (2 0)
                      push const string "y"
                    end get property ret values 1
                    ,
                    begin call method
                      get env var math
                      begin params 2
                        push const string "deg"
                        ,
                        begin get property
                          get local var xf (2 0)
                          push const string "angle"
                        end get property ret values 1
                      end params ret values 2
                    end call method ret values 1
                  end params ret values 3
                  push this
                  push const string "rotation"
                end set property ret values 2
                push this
                push const string "y"
              end set property ret values 1
              push this
              push const string "x"
            end set property ret values 0


[67] this.__physicsUpdateInProgress = false

            begin set property
              const false
              push this
              push const string "__physicsUpdateInProgress"
            end set property ret values 0
          end function
        end set by name: [__updateNodePosition]
        ,

[69] __get@physicsBody = function(){

        begin set by name
          begin function
            begin locals, total 2
              0 _E
              1 _G
            end locals

[70] return this.__physicsBody

            begin return
              begin get property
                push this
                push const string "__physicsBody"
              end get property ret values 1
            end return values 1
          end function
        end set by name: [__get@physicsBody]
        ,

[72] __set@x = function(a){

        begin set by name
          begin function
            begin locals, total 3
              0 a (param)
              1 _E
              2 _G
            end locals

[73] nodeSetX.call(this, a)

            begin call method
              get local var nodeSetX (7 1)
              begin params 3
                push const string "call"
                ,
                push this
                ,
                get local var a (0 0 param)
              end params ret values 3
            end call method ret values 0


[74] if(!this.__physicsUpdateInProgress){

            begin if
              begin bool exp
                begin logic not
                  begin get property
                    push this
                    push const string "__physicsUpdateInProgress"
                  end get property ret values 1
                end logic not
              end bool exp
              begin then

[75] this.__physicsBody.position = [this.x, this.y]

                begin scope
                  begin set property
                    begin array 2
                      begin set auto index
                        begin get property
                          push this
                          push const string "x"
                        end get property ret values 1
                      end set auto index
                      ,
                      begin set auto index
                        begin get property
                          push this
                          push const string "y"
                        end get property ret values 1
                      end set auto index
                    end array
                    begin get property auto create
                      push this
                      push const string "__physicsBody"
                    end get property auto create ret values 1
                    push const string "position"
                  end set property ret values 0
                end scope ret values 0
              end then
            end if ret values 0
          end function
        end set by name: [__set@x]
        ,

[78] __set@y = function(a){

        begin set by name
          begin function
            begin locals, total 3
              0 a (param)
              1 _E
              2 _G
            end locals

[79] nodeSetY.call(this, a)

            begin call method
              get local var nodeSetY (8 1)
              begin params 3
                push const string "call"
                ,
                push this
                ,
                get local var a (0 0 param)
              end params ret values 3
            end call method ret values 0


[80] if(!this.__physicsUpdateInProgress){

            begin if
              begin bool exp
                begin logic not
                  begin get property
                    push this
                    push const string "__physicsUpdateInProgress"
                  end get property ret values 1
                end logic not
              end bool exp
              begin then

[81] this.__physicsBody.position = [this.x, this.y]

                begin scope
                  begin set property
                    begin array 2
                      begin set auto index
                        begin get property
                          push this
                          push const string "x"
                        end get property ret values 1
                      end set auto index
                      ,
                      begin set auto index
                        begin get property
                          push this
                          push const string "y"
                        end get property ret values 1
                      end set auto index
                    end array
                    begin get property auto create
                      push this
                      push const string "__physicsBody"
                    end get property auto create ret values 1
                    push const string "position"
                  end set property ret values 0
                end scope ret values 0
              end then
            end if ret values 0
          end function
        end set by name: [__set@y]
      end object
    end params ret values 2
  end call method ret values 0


[86] function extractPoint(p){

  begin set env var
    begin function
      begin locals, total 3
        0 p (param)
        1 _E
        2 _G
      end locals

[87] if(arrayof p){

      begin if
        begin bool exp
          begin arrayof
            get local var p (0 0 param)
          end arrayof
        end bool exp
        begin then

[88] return p[0], p[1]

          begin scope
            begin return
              begin get property
                get local var p (0 0 param)
                push const number 0
              end get property ret values 1
              ,
              begin get property
                get local var p (0 0 param)
                push const number 1
              end get property ret values 1
            end return values 2
          end scope ret values 0
        end then
      end if ret values 0


[90] return p.x, p.y

      begin code list
        begin return
          begin get property
            get local var p (0 0 param)
            push const string "x"
          end get property ret values 1
          ,
          begin get property
            get local var p (0 0 param)
            push const string "y"
          end get property ret values 1
        end return values 2
      end code list ret values 0
    end function
  end set env var extractPoint


[93] function extractSize(p){

  begin set env var
    begin function
      begin locals, total 3
        0 p (param)
        1 _E
        2 _G
      end locals

[94] if(arrayof p){

      begin if
        begin bool exp
          begin arrayof
            get local var p (0 0 param)
          end arrayof
        end bool exp
        begin then

[95] return p[0], p[1]

          begin scope
            begin return
              begin get property
                get local var p (0 0 param)
                push const number 0
              end get property ret values 1
              ,
              begin get property
                get local var p (0 0 param)
                push const number 1
              end get property ret values 1
            end return values 2
          end scope ret values 0
        end then
      end if ret values 0


[97] return p.width, p.height

      begin code list
        begin return
          begin get property
            get local var p (0 0 param)
            push const string "width"
          end get property ret values 1
          ,
          begin get property
            get local var p (0 0 param)
            push const string "height"
          end get property ret values 1
        end return values 2
      end code list ret values 0
    end function
  end set env var extractSize


[100] function getBoxShapeVertices(leftTopCorner, size){

  begin set env var
    begin function
      begin locals, total 8
        0 leftTopCorner (param)
        1 size (param)
        2 _E
        3 _G
        4 x
        5 y
        6 width
        7 height
      end locals

[101] var x, y = extractPoint(leftTopCorner)

      begin set local var
        begin set local var
          begin call method
            get local var _E (2 0)
            begin params 2
              push const string "extractPoint"
              ,
              get local var leftTopCorner (0 0 param)
            end params ret values 2
          end call method ret values 2
        end set local var y (5 0)
      end set local var x (4 0)


[102] var width, height = extractSize(size)

      begin set local var
        begin set local var
          begin call method
            get local var _E (2 0)
            begin params 2
              push const string "extractSize"
              ,
              get local var size (1 0 param)
            end params ret values 2
          end call method ret values 2
        end set local var height (7 0)
      end set local var width (6 0)


[103] return [ [x, y], [x + width, y], [x + width, y + height], [x, y + height] ]

      begin code list
        begin return
          begin array 4
            begin set auto index
              begin array 2
                begin set auto index
                  get local var x (4 0)
                end set auto index
                ,
                begin set auto index
                  get local var y (5 0)
                end set auto index
              end array
            end set auto index
            ,
            begin set auto index
              begin array 2
                begin set auto index
                  begin operator +
                    get local var x (4 0)
                    get local var width (6 0)
                  end operator +
                end set auto index
                ,
                begin set auto index
                  get local var y (5 0)
                end set auto index
              end array
            end set auto index
            ,
            begin set auto index
              begin array 2
                begin set auto index
                  begin operator +
                    get local var x (4 0)
                    get local var width (6 0)
                  end operator +
                end set auto index
                ,
                begin set auto index
                  begin operator +
                    get local var y (5 0)
                    get local var height (7 0)
                  end operator +
                end set auto index
              end array
            end set auto index
            ,
            begin set auto index
              begin array 2
                begin set auto index
                  get local var x (4 0)
                end set auto index
                ,
                begin set auto index
                  begin operator +
                    get local var y (5 0)
                    get local var height (7 0)
                  end operator +
                end set auto index
              end array
            end set auto index
          end array
        end return values 1
      end code list ret values 0
    end function
  end set env var getBoxShapeVertices

  begin code list
    begin return
      get local var _E (0 0)
    end return values 1
  end code list ret values 0
end function
