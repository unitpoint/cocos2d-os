
[FILE] raw://../../engine-os/physics.os
[1] _E = extends _G {}

begin function
  begin locals, total 7
    0 _E
    1 _G
    2 world
    3 fixedTimeStep
    4 velocityIterations
    5 positionIterations
    6 timeAccumulator
  end locals
  begin set local var
    begin extends
      get local var _G (1 0)
      begin object 0
      end object
    end extends ret values 1
  end set local var _E (0 0)


[2] _G.physics = _E

  begin set property
    get local var _E (0 0)
    get local var auto create _G (1 0)
    push const string "physics"
  end set property ret values 0


[4] var world = b2World()

  begin set local var
    begin call method
      get local var _E (0 0)
      begin params 1
        push const string "b2World"
      end params ret values 1
    end call method ret values 1
  end set local var world (2 0)


[5] function get world(){ return world }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var world (2 1)
      end return values 1
    end function
  end set env var __get@world


[7] var fixedTimeStep = 1.0f / 60

  begin set local var
    push const number 0.0166667
  end set local var fixedTimeStep (3 0)


[8] var velocityIterations = 10

  begin set local var
    push const number 10
  end set local var velocityIterations (4 0)


[9] var positionIterations = 8

  begin set local var
    push const number 8
  end set local var positionIterations (5 0)


[10] var timeAccumulator = 0

  begin set local var
    push const number 0
  end set local var timeAccumulator (6 0)


[12] addEventListener("enterFrame", function(params){

  begin call method
    get local var _E (0 0)
    begin params 3
      push const string "addEventListener"
      ,
      push const string "enterFrame"
      ,
      begin function
        begin locals, total 3
          0 params (param)
          1 _E
          2 _G
        end locals

[13] timeAccumulator = timeAccumulator + params.deltaTime

        begin set local var
          begin operator +
            get local var timeAccumulator (6 1)
            begin get property
              get local var params (0 0 param)
              push const string "deltaTime"
            end get property ret values 1
          end operator +
        end set local var timeAccumulator (6 1)


[14] for(; timeAccumulator >= fixedTimeStep;){

        begin scope
          nop

          begin loop
            begin if
              begin bool exp
                begin logic not
                  begin logic >=
                    get local var timeAccumulator (6 1)
                    get local var fixedTimeStep (3 1)
                  end logic >=
                end logic not
              end bool exp
              begin then
                break
              end then
            end if ret values 0


[15] world.step(fixedTimeStep, velocityIterations, positionIterations)

            begin scope
              begin call method
                get local var world (2 1)
                begin params 4
                  push const string "step"
                  ,
                  get local var fixedTimeStep (3 1)
                  ,
                  get local var velocityIterations (4 1)
                  ,
                  get local var positionIterations (5 1)
                end params ret values 4
              end call method ret values 0


[16] timeAccumulator = timeAccumulator - fixedTimeStep

              begin set local var
                begin operator -
                  get local var timeAccumulator (6 1)
                  get local var fixedTimeStep (3 1)
                end operator -
              end set local var timeAccumulator (6 1)
            end scope ret values 0


[14] for(; timeAccumulator >= fixedTimeStep;){

            nop
          end loop ret values 0
        end scope ret values 0
      end function
    end params ret values 3
  end call method ret values 0


[20] function get velocityIterations(){ return velocityIterations }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var velocityIterations (4 1)
      end return values 1
    end function
  end set env var __get@velocityIterations


[21] function set velocityIterations(a){ velocityIterations = a }

  begin set env var
    begin function
      begin locals, total 3
        0 a (param)
        1 _E
        2 _G
      end locals
      begin set local var
        get local var a (0 0 param)
      end set local var velocityIterations (4 1)
    end function
  end set env var __set@velocityIterations


[23] function get positionIterations(){ return positionIterations }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var positionIterations (5 1)
      end return values 1
    end function
  end set env var __get@positionIterations


[24] function set positionIterations(a){ positionIterations = a }

  begin set env var
    begin function
      begin locals, total 3
        0 a (param)
        1 _E
        2 _G
      end locals
      begin set local var
        get local var a (0 0 param)
      end set local var positionIterations (5 1)
    end function
  end set env var __set@positionIterations


[26] function get fixedTimeStep(){ return fixedTimeStep }

  begin set env var
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals
      begin return
        get local var fixedTimeStep (3 1)
      end return values 1
    end function
  end set env var __get@fixedTimeStep


[27] function set fixedTimeStep(a){ fixedTimeStep = a }

  begin set env var
    begin function
      begin locals, total 3
        0 a (param)
        1 _E
        2 _G
      end locals
      begin set local var
        get local var a (0 0 param)
      end set local var fixedTimeStep (3 1)
    end function
  end set env var __set@fixedTimeStep


[29] function createBody(params){

  begin set env var
    begin function
      begin locals, total 3
        0 params (param)
        1 _E
        2 _G
      end locals

[30] return world.createBody(params)

      begin tail call method
        get local var world (2 1)
        begin params 2
          push const string "createBody"
          ,
          get local var params (0 0 param)
        end params ret values 2
      end tail call method
    end function
  end set env var createBody


[33] function destroyBody(params){

  begin set env var
    begin function
      begin locals, total 3
        0 params (param)
        1 _E
        2 _G
      end locals

[34] return world.destroyBody(params)

      begin tail call method
        get local var world (2 1)
        begin params 2
          push const string "destroyBody"
          ,
          get local var params (0 0 param)
        end params ret values 2
      end tail call method
    end function
  end set env var destroyBody


[37] PhysicsBodyNode = extends FunctionNode {

  begin set env var
    begin extends
      get env var FunctionNode
      begin object 3

[38] __object = {

        begin set by name
          begin object 1

[39] body = null

            begin set by name
              const null
            end set by name: [body]
          end object
        end set by name: [__object]
        ,

[41] __construct = function(parent, params){

        begin set by name
          begin function
            begin locals, total 5
              0 parent (param)
              1 params (param)
              2 _E
              3 _G
              4 createBody
            end locals

[42] params = clone params

            begin set local var
              begin clone
                get local var params (1 0 param)
              end clone
            end set local var params (1 0 param)


[44] var function createBody(){

            begin set local var
              begin function
                begin locals, total 2
                  0 _E
                  1 _G
                end locals

[45] if(!this.body){

                begin if
                  begin bool exp
                    begin logic not
                      begin get property
                        push this
                        push const string "body"
                      end get property ret values 1
                    end logic not
                  end bool exp
                  begin then

[46] this.body = world.createBody(params.merge {

                    begin scope
                      begin set property
                        begin call method
                          get local var world (2 2)
                          begin params 2
                            push const string "createBody"
                            ,
                            begin call method
                              get local var params (1 1 param)
                              begin params 2
                                push const string "merge"
                                ,
                                begin object 3

[47] x = parent.x

                                  begin set by name
                                    begin get property
                                      get local var parent (0 1 param)
                                      push const string "x"
                                    end get property ret values 1
                                  end set by name: [x]
                                  ,

[48] y = parent.y

                                  begin set by name
                                    begin get property
                                      get local var parent (0 1 param)
                                      push const string "y"
                                    end get property ret values 1
                                  end set by name: [y]
                                  ,

[49] angle = math.rad(parent.rotation)

                                  begin set by name
                                    begin call method
                                      get env var math
                                      begin params 2
                                        push const string "rad"
                                        ,
                                        begin get property
                                          get local var parent (0 1 param)
                                          push const string "rotation"
                                        end get property ret values 1
                                      end params ret values 2
                                    end call method ret values 1
                                  end set by name: [angle]
                                end object
                              end params ret values 2
                            end call method ret values 1
                          end params ret values 2
                        end call method ret values 1

[46] this.body = world.createBody(params.merge {

                        push this
                        push const string "body"
                      end set property ret values 0
                    end scope ret values 0
                  end then
                end if ret values 0
              end function
            end set local var createBody (4 0)


[53] createBody.call(this)

            begin call method
              get local var createBody (4 0)
              begin params 2
                push const string "call"
                ,
                push this
              end params ret values 2
            end call method ret values 0


[54] this.addEventListener("onEnter", function(){

            begin call method
              push this
              begin params 3
                push const string "addEventListener"
                ,
                push const string "onEnter"
                ,
                begin function
                  begin locals, total 2
                    0 _E
                    1 _G
                  end locals

[55] createBody.call(this)

                  begin call method
                    get local var createBody (4 1)
                    begin params 2
                      push const string "call"
                      ,
                      push this
                    end params ret values 2
                  end call method ret values 0


[56] this.addEventListener("enterFrame", this.update)

                  begin call method
                    push this
                    begin params 3
                      push const string "addEventListener"
                      ,
                      push const string "enterFrame"
                      ,
                      begin get property
                        push this
                        push const string "update"
                      end get property ret values 1
                    end params ret values 3
                  end call method ret values 0
                end function
              end params ret values 3
            end call method ret values 0


[58] this.addEventListener("onExit", function(){

            begin call method
              push this
              begin params 3
                push const string "addEventListener"
                ,
                push const string "onExit"
                ,
                begin function
                  begin locals, total 2
                    0 _E
                    1 _G
                  end locals

[59] this.removeEventListener("enterFrame", this.update)

                  begin call method
                    push this
                    begin params 3
                      push const string "removeEventListener"
                      ,
                      push const string "enterFrame"
                      ,
                      begin get property
                        push this
                        push const string "update"
                      end get property ret values 1
                    end params ret values 3
                  end call method ret values 0


[60] world.destroyBody(this.body)

                  begin call method
                    get local var world (2 2)
                    begin params 2
                      push const string "destroyBody"
                      ,
                      begin get property
                        push this
                        push const string "body"
                      end get property ret values 1
                    end params ret values 2
                  end call method ret values 0


[61] this.body = null

                  begin set property
                    const null
                    push this
                    push const string "body"
                  end set property ret values 0
                end function
              end params ret values 3
            end call method ret values 0


[63] "__physicsBodyNode" in parent && parent.remove(parent.__physicsBodyNode)

            begin pop
              begin logic &&
                begin in
                  push const string "__physicsBodyNode"
                  get local var parent (0 0 param)
                end in
                begin call method
                  get local var parent (0 0 param)
                  begin params 2
                    push const string "remove"
                    ,
                    begin get property
                      get local var parent (0 0 param)
                      push const string "__physicsBodyNode"
                    end get property ret values 1
                  end params ret values 2
                end call method ret values 1
              end logic &&
            end pop ret values 0


[64] parent.__physicsBodyNode = parent.insert(this)

            begin set property
              begin call method
                get local var parent (0 0 param)
                begin params 2
                  push const string "insert"
                  ,
                  push this
                end params ret values 2
              end call method ret values 1
              get local var auto create parent (0 0 param)
              push const string "__physicsBodyNode"
            end set property ret values 0
          end function
        end set by name: [__construct]
        ,

[67] update = function(){

        begin set by name
          begin function
            begin locals, total 4
              0 _E
              1 _G
              2 xf
              3 parent
            end locals

[68] var xf, parent = this.body.transform, this.parent

            begin set local var
              begin set local var
                begin params 2
                  begin get property
                    begin get property
                      push this
                      push const string "body"
                    end get property ret values 1
                    push const string "transform"
                  end get property ret values 1
                  ,
                  begin get property
                    push this
                    push const string "parent"
                  end get property ret values 1
                end params ret values 2
              end set local var parent (3 0)
            end set local var xf (2 0)


[69] parent.x, parent.y, parent.rotation = xf.x, xf.y, math.deg(xf.angle)

            begin set property
              begin set property
                begin set property
                  begin params 3
                    begin get property
                      get local var xf (2 0)
                      push const string "x"
                    end get property ret values 1
                    ,
                    begin get property
                      get local var xf (2 0)
                      push const string "y"
                    end get property ret values 1
                    ,
                    begin call method
                      get env var math
                      begin params 2
                        push const string "deg"
                        ,
                        begin get property
                          get local var xf (2 0)
                          push const string "angle"
                        end get property ret values 1
                      end params ret values 2
                    end call method ret values 1
                  end params ret values 3
                  get local var auto create parent (3 0)
                  push const string "rotation"
                end set property ret values 2
                get local var auto create parent (3 0)
                push const string "y"
              end set property ret values 1
              get local var auto create parent (3 0)
              push const string "x"
            end set property ret values 0
          end function
        end set by name: [update]
      end object
    end extends ret values 1
  end set env var PhysicsBodyNode


[73] function Node.addPhysicsBody(params){

  begin set property
    begin function
      begin locals, total 3
        0 params (param)
        1 _E
        2 _G
      end locals

[74] return PhysicsBodyNode(this, params).body

      begin return
        begin get property
          begin call method
            get local var _E (1 0)
            begin params 3
              push const string "PhysicsBodyNode"
              ,
              push this
              ,
              get local var params (0 0 param)
            end params ret values 3
          end call method ret values 1
          push const string "body"
        end get property ret values 1
      end return values 1
    end function

[73] function Node.addPhysicsBody(params){

    get env var auto create Node
    push const string "addPhysicsBody"
  end set property ret values 0


[77] function Node.__get@physicsBody(){

  begin set property
    begin function
      begin locals, total 2
        0 _E
        1 _G
      end locals

[78] return "__physicsBodyNode" in this ? this.__physicsBodyNode.body : null

      begin return
        begin question
          begin bool exp
            begin in
              push const string "__physicsBodyNode"
              push this
            end in
          end bool exp
          begin then value
            begin get property
              begin get property
                push this
                push const string "__physicsBodyNode"
              end get property ret values 1
              push const string "body"
            end get property ret values 1
          end then value
          begin else value
            const null
          end else value
        end question ret values 1
      end return values 1
    end function

[77] function Node.__get@physicsBody(){

    get env var auto create Node
    push const string "__get@physicsBody"
  end set property ret values 0


[78] return "__physicsBodyNode" in this ? this.__physicsBodyNode.body : null

  begin code list
    begin return
      get local var _E (0 0)
    end return values 1
  end code list ret values 0
end function
